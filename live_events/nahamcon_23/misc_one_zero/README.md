This challenge was basically done but harder in another CTF, and I used their solution:

https://medium.com/@orik_/34c3-ctf-minbashmaxfun-writeup-4470b596df60

The solve script was copied here in case that link goes down.